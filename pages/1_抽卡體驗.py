
CARD_SYSTEMS = {
    "è²´äºº": {
        "color_primary": "#F2D9B3",
        "color_secondary": "#FBEDE3",
        "samples": {
            "å æ˜Ÿ": {
                "fortune": "æ˜Ÿç›¤é¡¯ç¤ºè²´äººæ­£åœ¨é è¿‘ä½ ã€‚",
                "note": "ä½ ä¸å¿…ç¨è‡ªä¸€äººèµ°å®Œå…¨ç¨‹ï¼Œå®‡å®™å·²ç¶“åœ¨å®‰æ’ç›¸é‡ã€‚",
                "task": "ä¸»å‹•å•å€™ä¸€ä½å¥½ä¹…ä¸è¯çµ¡çš„æœ‹å‹ã€‚"
            },
            "å¿ƒç†": {
                "fortune": "ä½ å…§åœ¨çš„å®ˆè­·è€…åŸå‹æ­£æº–å‚™å‡ºå ´ã€‚",
                "note": "å…è¨±è‡ªå·±æ¥å—å¹«åŠ©ï¼Œæ˜¯æˆç†Ÿèˆ‡å‹‡æ°£ã€‚",
                "task": "ä»Šå¤©èªªå‡ºä¸€å¥ã€éœ€è¦å¹«å¿™ã€ï¼Œä¸¦æ¥å—å®ƒã€‚"
            },
            "å®‡å®™": {
                "fortune": "éŠ€å…‰å°ç‹å°‡åœ¨ä½ éœ€è¦æ™‚å‡ºç¾ã€‚",
                "note": "ç•¶ä½ å–„å¾…è‡ªå·±ï¼Œè²´äººå°±æœƒçœ‹è¦‹ä½ çš„å…‰ã€‚",
                "task": "å¯«ä¸‹æ„Ÿè¬æ¸…å–® 3 ä»¶äº‹ã€‚"
            }
        }
    },
    "å¹¸é‹": {
        "color_primary": "#C5E7D4",
        "color_secondary": "#FFD5A5",
        "samples": {
            "å æ˜Ÿ": {
                "fortune": "ä»Šæ™šçš„æœˆäº®å¸¶ä¾†å¹¸é‹æ˜Ÿå¡µã€‚",
                "note": "åšä¸€ä»¶å¹³å¸¸ä¸æœƒåšçš„å°äº‹ï¼Œå®‡å®™å–œæ„›ä½ çš„å¥½å¥‡ã€‚",
                "task": "æ›ä¸€å®¶å’–å•¡åº—ï¼Œé»ä¸€å€‹æ–°å£å‘³ã€‚"
            },
            "å¿ƒç†": {
                "fortune": "ä½ æ­£åœ¨é€²å…¥å¿ƒæµå€ã€‚",
                "note": "æ”¾é¬†ä¸æ˜¯å·æ‡¶ï¼Œè€Œæ˜¯è®“èƒ½é‡å›åˆ°ä½ èº«ä¸Šã€‚",
                "task": "å®‰æ’ 15 åˆ†é˜æ­¥è¡Œï¼Œç•™æ„æ²¿é€”çš„å°ç¾å¥½ã€‚"
            },
            "å®‡å®™": {
                "fortune": "ä¸€é¡†å½©è‰²å½—æ˜Ÿå‰›ç¶“éã€‚",
                "note": "ä»Šå¤©ä»»ä½•å°äº‹éƒ½å¯èƒ½è®Šæˆå¤§é©šå–œã€‚",
                "task": "å°é‡åˆ°çš„ç¬¬ä¸€ä½åº—å“¡èªªã€ä»Šå¤©è¾›è‹¦äº†ã€ã€‚"
            }
        }
    },
    "å‹‡æ°£": {
        "color_primary": "#FF9B58",
        "color_secondary": "#FF6B6B",
        "samples": {
            "å æ˜Ÿ": {
                "fortune": "ç«æ˜Ÿèƒ½é‡æ­£æ—ºç››ã€‚",
                "note": "åˆ¥å†ç­‰å¾…å®Œç¾æ™‚æ©Ÿï¼Œè¡Œå‹•å°±æ˜¯æœ€å¥½çš„æ™‚æ©Ÿã€‚",
                "task": "å°‡æ‹–å»¶çš„ä¸€ä»¶äº‹ï¼Œç¾åœ¨åš 5 åˆ†é˜ã€‚"
            },
            "å¿ƒç†": {
                "fortune": "ä½ æ­£åœ¨å¾ææ‡¼å€èµ°å‘æˆé•·å€ã€‚",
                "note": "å®³æ€•ä¸æœƒæ¶ˆå¤±ï¼Œä½†ä½ å¯ä»¥å¸¶è‘—å®³æ€•å¾€å‰èµ°ã€‚",
                "task": "å¯«ä¸‹ä½ æœ€å°å¯è¡Œçš„ä¸‹ä¸€æ­¥ï¼Œç«‹åˆ»åŸ·è¡Œã€‚"
            },
            "å®‡å®™": {
                "fortune": "å®‡å®™çµ¦ä½ ä¸€æšå‹‡æ°£å‹³ç« ã€‚",
                "note": "ä»Šå¤©å°±æ˜¯ä½ çš„ä¸»å ´ï¼Œèˆå°ç‡ˆå·²ç¶“æ‰“é–‹ã€‚",
                "task": "ä¸»å‹•æå‡ºä¸€å€‹æƒ³æ³•ï¼Œç„¡è«–å¤§å°ã€‚"
            }
        }
    },
    "éˆæ„Ÿ": {
        "color_primary": "#A3A8F5",
        "color_secondary": "#D8C7F5",
        "samples": {
            "å æ˜Ÿ": {
                "fortune": "æ°´ç“¶åº§çš„é¢¨å¸¶ä¾†æ–°çš„è¦–è§’ã€‚",
                "note": "æ›å€‹è§’åº¦çœ‹ï¼Œä½ æœƒç™¼ç¾æ–°çš„è·¯ã€‚",
                "task": "æŠŠä»Šå¤©çš„å›°æ“¾å¯«æˆä¸€å€‹å•é¡Œï¼Œå•å•æ˜å¤©çš„ä½ ã€‚"
            },
            "å¿ƒç†": {
                "fortune": "ç­”æ¡ˆå…¶å¯¦ä¸€ç›´åœ¨ä½ å¿ƒè£¡ã€‚",
                "note": "ç©ºç™½ä¸æ˜¯ç©ºç„¡ï¼Œè€Œæ˜¯å­•è‚²æ–°æ„çš„åœŸå£¤ã€‚",
                "task": "10 åˆ†é˜è‡ªç”±æ›¸å¯«ï¼Œä¸è¦ä¿®æ”¹ã€‚"
            },
            "å®‡å®™": {
                "fortune": "æ˜Ÿé›²ç²¾éˆä½èªï¼šæŠŠä¸å¯èƒ½ç•¶ä½œéŠæˆ²ä¾†ç©ã€‚",
                "note": "å‰µé€ åŠ›ä¾†è‡ªå…è¨±è‡ªå·±çŠ¯éŒ¯ã€‚",
                "task": "ç•«ä¸€å¼µå®Œå…¨ä¸åœ¨ä¹å¥½å£çš„å¡—é´‰ã€‚"
            }
        }
    }
}
SCHOOLS = ["å æ˜Ÿ", "å¿ƒç†", "å®‡å®™"]
DEFAULT_USER = "è¨ªå®¢"
import os
DATA_DIR = os.path.join(os.getcwd(), "data") if os.path.exists(os.path.join(os.getcwd(), "data")) else "/mnt/data"
DRAW_LOG = os.path.join(DATA_DIR, "draw_log.csv")
SIGNIN_LOG = os.path.join(DATA_DIR, "signin_log.csv")
os.makedirs(DATA_DIR, exist_ok=True)

import streamlit as st, os, pandas as pd, random
from datetime import datetime
from PIL import Image, ImageDraw, ImageFont

st.set_page_config(page_title='æŠ½å¡é«”é©—', page_icon='âœ¨', layout='centered')

st.title('âœ¨ æŠ½å¡é«”é©—')
username = st.session_state.get('username') or DEFAULT_USER
school = st.session_state.get('school', 'å æ˜Ÿ')

st.markdown(f'ä½¿ç”¨è€…ï¼š**{username}**ï½œåå¥½å­¸æ´¾ï¼š**{school}**')

today_key = f'{username}-{datetime.now().date()}-seed'
if 'seed' not in st.session_state or st.session_state.get('seed_key') != today_key:
    import random
    st.session_state.seed = random.randint(0, 10**9)
    st.session_state.seed_key = today_key
rng = random.Random(st.session_state.seed)

selected_system = st.selectbox('é¸æ“‡å¡ç³»', list(CARD_SYSTEMS.keys()), index=0)

def draw_card(system_name, school_name):
    data = CARD_SYSTEMS[system_name]['samples'][school_name]
    return {
        'system': system_name,
        'school': school_name,
        'fortune': data['fortune'],
        'note': data['note'],
        'task': data['task'],
        'color_primary': CARD_SYSTEMS[system_name]['color_primary'],
        'color_secondary': CARD_SYSTEMS[system_name]['color_secondary'],
        'ts': datetime.now().isoformat(timespec='seconds'),
        'user': username
    }

if st.button('ğŸ² ä»Šå¤©æŠ½ä¸€å¼µ', use_container_width=True):
    result = draw_card(selected_system, school)
    st.session_state.last_card = result

card = st.session_state.get('last_card')
if card:
    st.success(f"ä½ æŠ½åˆ°ï¼š**{card['system']}å¡**ï¼ˆå­¸æ´¾ï¼š{card['school']}ï¼‰")
    with st.container(border=True):
        st.markdown(f"**ç±¤èª**ï¼š{card['fortune']}" )
        st.markdown(f"**å°èª**ï¼š{card['note']}" )
        st.markdown(f"**ä»Šæ—¥ä»»å‹™**ï¼š{card['task']}" )
    import csv
    header = ['ts','user','system','school','fortune','note','task']
    first = not os.path.exists(DRAW_LOG)
    with open(DRAW_LOG, 'a', encoding='utf-8', newline='') as f:
        w = csv.writer(f)
        if first: w.writerow(header)
        w.writerow([card['ts'], card['user'], card['system'], card['school'], card['fortune'], card['note'], card['task']])

    st.markdown('â€”')
    st.subheader('ğŸ–¼ï¸ ç”Ÿæˆåˆ†äº«åœ–å¡')
    if st.button('ç”Ÿæˆ PNG åœ–å¡', use_container_width=True):
        W, H = 1080, 1350
        from PIL import Image, ImageDraw
        bg = Image.new('RGB', (W,H), card['color_primary'])
        draw = ImageDraw.Draw(bg)
        pad = 64
        title = f"AI å¹¸é‹å¡ï½œ{card['system']}"
        draw.text((pad, pad), title, fill=(30,30,30))

        def write_block(y, label, content):
            draw.text((pad, y), label, fill=(50,50,50))
            y += 48
            import textwrap
            wrapped = textwrap.fill(content, width=18)
            draw.multiline_text((pad, y), wrapped, fill=(20,20,20), spacing=8)
            lines = wrapped.count('\n') + 1
            return y + 32*lines + 24

        y = 160
        y = write_block(y, 'ç±¤èª', card['fortune'])
        y = write_block(y, 'å°èª', card['note'])
        y = write_block(y, 'ä»Šæ—¥ä»»å‹™', card['task'])
        draw.text((pad, H-100), f"{username} Â· {datetime.now().date()}", fill=(40,40,40))
        draw.text((W-520, H-100), 'gracefo.com Â· æ°¸å‚³å®¶æ—å‚³æ‰¿å°å¸«', fill=(40,40,40))

        out_path = os.path.join(DATA_DIR, f"share_{datetime.now().strftime('%Y%m%d_%H%M%S')}.png")
        bg.save(out_path, 'PNG')
        st.image(bg, caption='åˆ†äº«åœ–é è¦½', use_container_width=True)
        st.download_button('ä¸‹è¼‰åˆ†äº«åœ–ï¼ˆPNGï¼‰', data=open(out_path, 'rb').read(), file_name=os.path.basename(out_path), mime='image/png', use_container_width=True)
else:
    st.info('é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼ŒæŠ½å‡ºä½ çš„ä»Šæ—¥å¹¸é‹å¡ âœ¨')
